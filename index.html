<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Rupixo ‚Äî Login / Register</title>
<style>
  :root{--bg:#05060a;--card:#0b1220;--accent:#0b84ff;--muted:#9aa6bf}
  *{box-sizing:border-box} body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial;background:linear-gradient(180deg,var(--bg),#071025);color:#e6f0ff}
  header{padding:16px 18px;border-bottom:1px solid #0f2446}
  h1{margin:0;color:var(--accent);font-size:20px}
  .wrap{max-width:980px;margin:24px auto;padding:0 14px}
  .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:14px}
  .card{background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,.02));border:1px solid #0f2446;border-radius:14px;padding:16px;box-shadow:0 12px 28px rgba(2,6,23,.6)}
  input{width:100%;padding:10px;border-radius:10px;border:1px solid #13325f;background:transparent;color:#e6f0ff;margin-top:8px}
  button{background:var(--accent);border:none;padding:10px 14px;border-radius:10px;color:#fff;margin-top:10px;cursor:pointer}
  .small{font-size:12px;color:var(--muted)}
  .banner{height:70px;border-radius:12px;display:flex;align-items:center;justify-content:center;border:2px dashed #17386d;color:#9bb9e6;font-weight:700;margin-top:10px}
</style>
</head>
<body>
<header><h1>Rupixo</h1></header>
<div class="wrap">
  <div class="grid">
    <!-- Login -->
    <div class="card">
      <h2>Login</h2>
      <input id="loginEmail" type="email" placeholder="Email">
      <input id="loginPass" type="password" placeholder="Password">
      <button id="loginBtn">Login</button>
      <div class="banner">Banner Ad ‚Äî <b>AD ID HERE</b></div>
      <div class="small" style="margin-top:8px">Login ‡§ï‡§∞‡§®‡•á ‡§™‡§∞ ‡§Ü‡§™‡§ï‡§æ previous coins balance Firebase ‡§∏‡•á ‡§≤‡•ã‡§° ‡§π‡•ã‡§ó‡§æ‡•§</div>
    </div>
    <!-- Register -->
    <div class="card">
      <h2>Register</h2>
      <input id="regName" type="text" placeholder="Full name">
      <input id="regEmail" type="email" placeholder="Email">
      <input id="regPass" type="password" placeholder="Password (min 6)">
      <button id="regBtn">Create Account</button>
      <div class="banner">Banner Ad ‚Äî <b>AD ID HERE</b></div>
      <div class="small" style="margin-top:8px">Register ‡§π‡•ã‡§§‡•á ‡§π‡•Ä Telegram ‡§™‡§∞ notification ‡§ú‡§æ‡§è‡§ó‡§æ‡•§</div>
    </div>
  </div>
</div>

<!-- Ad modal + All helpers -->
<script type="module" src="./app.js"></script>
<script type="module">
import { RPX } from './app.js'; // just to ensure module loads (not used directly)
const { auth, createUserWithEmailAndPassword, signInWithEmailAndPassword, updateProfile, ensureUserDoc, sendTG, notify } = window.RPX;

document.getElementById('regBtn').onclick = async ()=>{
  const name = document.getElementById('regName').value.trim();
  const email= document.getElementById('regEmail').value.trim();
  const pass = document.getElementById('regPass').value;
  if(!name||!email||pass.length<6){ notify('Fill all fields (pass ‚â• 6)'); return}
  try{
    const cred = await createUserWithEmailAndPassword(auth,email,pass);
    await updateProfile(cred.user,{displayName:name});
    await ensureUserDoc(cred.user.uid,{name, email});
    sendTG(`New registration:\nName: ${name}\nEmail: ${email}`);
    localStorage.setItem('rupixo_uid', cred.user.uid);
    location.href = './home.html';
  }catch(e){ notify(e.message||'Register failed'); }
};

document.getElementById('loginBtn').onclick = async ()=>{
  const email= document.getElementById('loginEmail').value.trim();
  const pass = document.getElementById('loginPass').value;
  if(!email||!pass){ notify('Enter email & password'); return}
  try{
    const cred = await signInWithEmailAndPassword(auth,email,pass);
    await ensureUserDoc(cred.user.uid); // make sure profile exists
    sendTG(`Login: ${email} at ${new Date().toLocaleString()}`);
    localStorage.setItem('rupixo_uid', cred.user.uid);
    location.href = './home.html';
  }catch(e){ notify(e.message||'Login failed'); }
};
</script>
</body>
</html>
<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Rupixo ‚Äî Home</title>
<style>
  :root{--bg:#05060a;--card:#0b1220;--accent:#0b84ff;--muted:#9aa6bf}
  *{box-sizing:border-box} body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial;background:linear-gradient(180deg,var(--bg),#071025);color:#e6f0ff}
  header{display:flex;justify-content:space-between;align-items:center;padding:14px 18px;border-bottom:1px solid #0f2446}
  h1{margin:0;color:var(--accent);font-size:20px}
  .coins{background:linear-gradient(90deg,#06203a,#06264a);padding:8px 12px;border-radius:10px}
  .wrap{max-width:1200px;margin:18px auto;padding:0 14px}
  .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:14px}
  .card{background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,.02));border:1px solid #0f2446;border-radius:14px;padding:14px;box-shadow:0 12px 28px rgba(2,6,23,.6)}
  .small{font-size:12px;color:var(--muted)}
  button{background:var(--accent);border:none;padding:10px 14px;border-radius:10px;color:#fff;cursor:pointer}
  input,select{width:100%;padding:10px;border-radius:10px;border:1px solid #13325f;background:transparent;color:#e6f0ff;margin-top:8px}
  .banner{height:68px;border-radius:12px;display:flex;align-items:center;justify-content:center;border:2px dashed #17386d;color:#9bb9e6;font-weight:700}
  .banners6{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:10px}
  .right{width:320px}
  @media(max-width:980px){.layout{display:block}.right{width:100%}}
</style>
</head>
<body>
<header>
  <h1>Rupixo</h1>
  <div style="display:flex;gap:10px;align-items:center">
    <div id="topCoins" class="coins">Coins: 0</div>
    <button id="logoutBtn" style="background:transparent;border:1px solid #224b85">Logout</button>
  </div>
</header>

<div class="wrap">
  <div class="layout" style="display:flex;gap:14px;align-items:flex-start">
    <div style="flex:1">
      <!-- Profile card -->
      <div class="card">
        <div style="display:flex;justify-content:space-between;gap:12px;align-items:center">
          <div>
            <h2 id="uName" style="margin:0 0 6px">User</h2>
            <div class="small">Email: <span id="uEmail"></span></div>
            <div class="small">Password: <span id="uPass">‚Ä¢‚Ä¢‚Ä¢‚Ä¢</span></div>
            <div class="small">Withdrawals: <span id="wCount">0</span></div>
          </div>
          <div class="coins" id="mainCoins">0</div>
        </div>
      </div>

      <!-- 6 Banners spaced out -->
      <div class="card">
        <h3 style="margin:0 0 8px">Sponsored</h3>
        <div class="banners6">
          <div class="banner">Banner 1 ‚Äî <b>AD ID HERE</b></div>
          <div class="banner">Banner 2 ‚Äî <b>AD ID HERE</b></div>
          <div class="banner">Banner 3 ‚Äî <b>AD ID HERE</b></div>
          <div class="banner">Banner 4 ‚Äî <b>AD ID HERE</b></div>
          <div class="banner">Banner 5 ‚Äî <b>AD ID HERE</b></div>
          <div class="banner">Banner 6 ‚Äî <b>AD ID HERE</b></div>
        </div>
      </div>

      <!-- Rewards -->
      <div class="grid">
        <div class="card">
          <h3>Daily Reward</h3>
          <div class="small">‡§π‡§∞ ‡§¶‡§ø‡§® 1 ‡§¨‡§æ‡§∞‚Äî‡§™‡§π‡§≤‡•á ‡§è‡§ï ad (Rewarded Ad ID HERE), ‡§´‡§ø‡§∞ 20 coins ‡§Æ‡§ø‡§≤‡•á‡§Ç‡§ó‡•á‡•§</div>
          <button id="dailyBtn">Watch ad & Claim (20)</button>
        </div>

        <div class="card">
          <h3>Watch Ad & Earn</h3>
          <div class="small">‡§π‡§∞ ad ‡§ï‡•á ‡§¨‡§æ‡§¶ 10 coins‡•§ Daily limit: 25‡•§ ‡§®‡•Ä‡§ö‡•á ad code ‡§≤‡§ó‡§æ‡§ì: <b>Ad code here</b></div>
          <button id="watchBtn">Watch ad (earn 10)</button>
          <div class="small" id="watchRemain"></div>
        </div>

        <div class="card">
          <h3>Spin & Earn</h3>
          <div class="small">‡§π‡§∞ spin ‡§∏‡•á ‡§™‡§π‡§≤‡•á 1 ad‡•§ Daily limit 10. Reward 1‚Äì7 coins.</div>
          <button id="spinBtn">Spin (1 ad)</button>
          <div class="small" id="spinResult"></div>
        </div>

        <div class="card">
          <h3>Scratch & Earn</h3>
          <div class="small">Daily 10 scratch‡•§ ‡§π‡§∞ scratch ‡§∏‡•á ‡§™‡§π‡§≤‡•á 1 ad‡•§ Reward 0‚Äì6 coins.</div>
          <button id="scratchBtn">Open Scratch</button>
        </div>

        <div class="card">
          <h3>Quiz & Earn</h3>
          <div class="small">10 ‡§∏‡§µ‡§æ‡§≤, ‡§∏‡§π‡•Ä ‡§™‡§∞ 10 coins‡•§ ‡§π‡§∞ 2 ‡§∏‡§µ‡§æ‡§≤ ‡§™‡§∞ 1 ad. ‡§Ö‡§≤‡§ó page ‡§™‡§∞ banner: <b>AD ID HERE</b></div>
          <button onclick="location.href='./quiz.html'">Open Quiz</button>
        </div>

        <div class="card">
          <h3>Refer & Earn</h3>
          <div class="small">‡§Ö‡§™‡§®‡§æ code share ‡§ï‡§∞‡•ã‚Äî‡§¶‡•Ç‡§∏‡§∞‡§æ user ‡§°‡§æ‡§≤‡§§‡§æ ‡§π‡•à ‡§§‡•ã ‡§¶‡•ã‡§®‡•ã‡§Ç ‡§ï‡•ã 50 coins (‡§™‡•ç‡§∞‡§§‡§ø user 1 ‡§¨‡§æ‡§∞)‡•§</div>
          <div class="small" id="myRef"></div>
          <input id="enterRef" placeholder="Enter friend's code">
          <button id="applyRef">Apply</button>
        </div>

        <div class="card" style="grid-column:1/-1">
          <h3>Redeem</h3>
          <div class="small">Thresholds: 3000‚Üí‚Çπ10, 10000‚Üí‚Çπ50, 20000‚Üí‚Çπ100 ‚Ä¢ Method: UPI / Redeem code (email)</div>
          <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:10px">
            <div>
              <select id="redeemType">
                <option value="upi">UPI</option>
                <option value="code">Redeem Code (email)</option>
              </select>
            </div>
            <div><input id="redeemTarget" placeholder="Enter UPI ID or Email"></div>
            <div>
              <select id="redeemAmt">
                <option value="3000">3000 coins ‚Üí ‚Çπ10</option>
                <option value="10000">10000 coins ‚Üí ‚Çπ50</option>
                <option value="20000">20000 coins ‚Üí ‚Çπ100</option>
              </select>
            </div>
            <div><button id="redeemBtn">Submit Redeem</button></div>
          </div>
          <div class="small" style="margin-top:8px">Request submit ‡§π‡•ã‡§§‡•á ‡§π‡•Ä ‡§Ü‡§™‡§ï‡•ã message ‡§¶‡§ø‡§ñ‡•á‡§ó‡§æ ‡§î‡§∞ admin (Telegram) ‡§™‡§∞ details ‡§™‡§π‡•Å‡§Å‡§ö ‡§ú‡§æ‡§è‡§Å‡§ó‡•Ä‡•§</div>
        </div>
      </div>
    </div>

    <!-- Right column -->
    <div class="right">
      <div class="card">
        <h3>Profile & History</h3>
        <div class="small">Name: <span id="pName"></span></div>
        <div class="small">Email: <span id="pEmail"></span></div>
        <div class="small">Coins: <span id="pCoins">0</span></div>
        <hr style="border-color:#0f2446">
        <div class="small">Withdrawals:</div>
        <div id="wList" class="small" style="max-height:220px;overflow:auto"></div>
      </div>

      <div class="card">
        <h3>About & Rules</h3>
        <p class="small">Rupixo ‚Äî demo rewards platform. One account per person. Abuse ‚Üí ban. Owner on Telegram.</p>
        <div class="small">Connect us</div>
        <div class="small" style="font-size:11px">Contact: @Gotm</div>
      </div>

      <div class="card">
        <h3>Side Banners</h3>
        <div class="banner">AD ID HERE</div>
        <div class="banner" style="margin-top:8px">AD ID HERE</div>
      </div>
    </div>
  </div>
</div>

<script type="module" src="./app.js"></script>
<script type="module">
const { auth, onAuthStateChanged, signOut, loadUserDoc, addCoins, getCounters, setCounter, genRef, showAd, notify, sendTG, ref, update, push } = window.RPX;

let UID=null, USER=null;

document.getElementById('logoutBtn').onclick = ()=> signOut(auth).then(()=>location.href='./index.html');

onAuthStateChanged(auth, async (user)=>{
  if(!user){ location.href='./index.html'; return; }
  UID = user.uid;
  USER = await loadUserDoc(UID);
  if(!USER){ location.href='./index.html'; return; }
  render();
});

function render(){
  document.getElementById('uName').innerText = USER.name||'User';
  document.getElementById('uEmail').innerText= USER.email||'';
  document.getElementById('uPass').innerText = '‚Ä¢‚Ä¢‚Ä¢‚Ä¢'; // masked
  setCoinsUI(USER.coins||0);
  document.getElementById('wCount').innerText = (USER.withdraws?.length||0);
  document.getElementById('pName').innerText = USER.name||'';
  document.getElementById('pEmail').innerText = USER.email||'';
  document.getElementById('pCoins').innerText = USER.coins||0;
  document.getElementById('myRef').innerText = 'Your code: '+ (USER.refCode || genRef(USER.email||""));
  const wl = USER.withdraws||[];
  document.getElementById('wList').innerHTML = wl.map(w=>`<div style="padding:6px;border-bottom:1px solid #0f2446">${new Date(w.ts).toLocaleString()} ‚Äî ${w.coins} coins ‚Äî ${w.type} ‚Äî ${w.target} ‚Äî ${w.status}</div>`).join('');
  updateWatchRemain();
}

function setCoinsUI(v){
  document.getElementById('topCoins').innerText = 'Coins: '+v;
  document.getElementById('mainCoins').innerText = v;
  document.getElementById('pCoins').innerText = v;
}

// ===== Daily Reward (1/day, +20) =====
document.getElementById('dailyBtn').onclick = async ()=>{
  const ok = await showAd(); if(!ok) return notify('Watch ad to claim');
  const c = await getCounters(UID);
  if(c?.daily){ return notify('Already claimed today'); }
  await setCounter(UID,'daily');
  await addCoins(UID,20,'Daily reward');
};

// ===== Watch Ad (limit 25/day, +10 each) =====
function updateWatchRemain(){
  getCounters(UID).then(c=>{
    const used = Number(c?.watch || 0);
    document.getElementById('watchRemain').innerText = `${25 - used} remaining today`;
  });
}
document.getElementById('watchBtn').onclick = async ()=>{
  const c = await getCounters(UID);
  const used = Number(c?.watch || 0);
  if(used>=25) return notify('Daily watch limit reached');
  const ok = await showAd(); if(!ok) return notify('Ad not watched');
  await setCounter(UID,'watch', (c.watch||0)+1);
  await addCoins(UID,10,'Ad watch');
  // store increment value
  await window.RPX.update(window.RPX.ref(window.RPX.db, `users/${UID}/counters/${window.RPX.todayKey()}`), {watch: used+1});
  updateWatchRemain();
};

// ===== Spin (limit 10/day, 1..7) =====
document.getElementById('spinBtn').onclick = async ()=>{
  const c = await getCounters(UID);
  const used = Number(c?.spin || 0);
  if(used>=10) return notify('Spin limit reached');
  const ok = await showAd(); if(!ok) return notify('Watch ad first');
  const coins = Math.floor(Math.random()*7)+1;
  await addCoins(UID, coins, 'Spin');
  document.getElementById('spinResult').innerText = `You won ${coins} coins`;
  await window.RPX.update(window.RPX.ref(window.RPX.db, `users/${UID}/counters/${window.RPX.todayKey()}`), {spin: used+1});
};

// ===== Scratch (limit 10/day, 0..6) =====
document.getElementById('scratchBtn').onclick = async ()=>{
  const c = await getCounters(UID);
  const used = Number(c?.scratch || 0);
  if(used>=10) return notify('Scratch limit reached');
  const ok = await showAd(); if(!ok) return notify('Watch ad first');
  const coins = Math.floor(Math.random()*7); // 0..6
  await addCoins(UID, coins, 'Scratch');
  notify(`Scratch: +${coins}`);
  await window.RPX.update(window.RPX.ref(window.RPX.db, `users/${UID}/counters/${window.RPX.todayKey()}`), {scratch: used+1});
};

// ===== Refer (+50 both, once) =====
document.getElementById('applyRef').onclick = async ()=>{
  const code = document.getElementById('enterRef').value.trim();
  if(!code) return notify('Enter code');
  const all = await window.RPX.get(window.RPX.ref(window.RPX.db,'users'));
  if(!all.exists()) return notify('Invalid code');
  const users = all.val()||{};
  const ownerUid = Object.keys(users).find(k=>users[k]?.refCode===code);
  if(!ownerUid) return notify('Invalid code');
  if(ownerUid===UID) return notify('Cannot use your own code');
  const me = await loadUserDoc(UID);
  if(me.usedRef) return notify('You already used a code');
  await addCoins(UID,50,'Referral used');
  await addCoins(ownerUid,50,'Referral reward');
  await window.RPX.update(window.RPX.ref(window.RPX.db, `users/${UID}`), {usedRef: code});
  notify('Referral applied (+50 each)');
};

// ===== Redeem (UPI / Code) =====
document.getElementById('redeemBtn').onclick = async ()=>{
  const type = (document.getElementById('redeemType').value||'upi');
  const target = document.getElementById('redeemTarget').value.trim();
  const amt = parseInt(document.getElementById('redeemAmt').value,10);
  if(!target) return notify('Enter UPI ID or Email');
  const u = await loadUserDoc(UID);
  if((u.coins||0) < amt) return notify('Not enough coins');
  // deduct & store withdraw
  const w = {ts:Date.now(), type, target, coins:amt, status:'Requested'};
  const list = u.withdraws||[]; list.unshift(w);
  await update(window.RPX.ref(window.RPX.db, `users/${UID}`), {coins:(u.coins-amt), withdraws:list});
  // Admin notification
  const msg = `Redeem Request:
User: ${u.email}
Type: ${type}
Target: ${target}
Coins: ${amt}
Time: ${new Date().toLocaleString()}`;
  sendTG(msg);
  notify('Redeem requested ‚Äî 24 hours ‡§Æ‡•á‡§Ç payment ‡§Ü‡§è‡§ó‡§æ');
  // UI refresh
  USER = await loadUserDoc(UID); render();
};
</script>
</body>
</html>
<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
<title>Rupixo ‚Äî Quiz</title>
<style>
  :root{--bg:#05060a;--card:#0b1220;--accent:#0b84ff;--muted:#9aa6bf}
  body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial;background:linear-gradient(180deg,var(--bg),#071025);color:#e6f0ff}
  header{display:flex;justify-content:space-between;align-items:center;padding:14px 18px;border-bottom:1px solid #0f2446}
  h1{margin:0;color:var(--accent);font-size:20px}
  .wrap{max-width:800px;margin:18px auto;padding:0 14px}
  .card{background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,.02));border:1px solid #0f2446;border-radius:14px;padding:14px}
  .banner{height:68px;border-radius:12px;display:flex;align-items:center;justify-content:center;border:2px dashed #17386d;color:#9bb9e6;font-weight:700;margin:10px 0}
  button{background:var(--accent);border:none;padding:10px 14px;border-radius:10px;color:#fff;cursor:pointer;margin-top:8px}
</style>
</head>
<body>
<header>
  <h1>Rupixo ‚Äî Quiz</h1>
  <button onclick="location.href='./home.html'" style="background:transparent;border:1px solid #224b85">Back</button>
</header>
<div class="wrap">
  <div class="banner">Quiz Banner ‚Äî <b>AD ID HERE</b></div>

  <div class="card" id="qCard">
    <div id="qText" style="font-size:18px;margin-bottom:10px">Loading‚Ä¶</div>
    <div id="opts"></div>
  </div>
</div>

<script type="module" src="./app.js"></script>
<script type="module">
const { auth, onAuthStateChanged, addCoins, showAd, notify } = window.RPX;

const bank = [
  {q:'What is 2 + 2?', a:['3','4','5'], ok:1},
  {q:'Capital of India?', a:['Mumbai','New Delhi','Kolkata'], ok:1},
  {q:'HTML stands for?', a:['HyperText Markup Language','Home Tool','HighText'], ok:0},
  {q:'JS is used for?', a:['Styling','Interaction','Database'], ok:1},
  {q:'CSS controls?', a:['Behavior','Layout & Style','Content'], ok:1},
  {q:'Which is a fruit?', a:['Carrot','Apple','Potato'], ok:1},
  {q:'5 √ó 3 = ?', a:['15','10','20'], ok:0},
  {q:'Sun rises from?', a:['West','East','North'], ok:1},
  {q:'Water formula?', a:['CO2','H2O','O2'], ok:1},
  {q:'Largest planet?', a:['Earth','Jupiter','Mars'], ok:1}
];

let UID=null, idx=0, order=[];
onAuthStateChanged(auth, (user)=>{
  if(!user) return location.href='./index.html';
  UID = user.uid;
  start();
});

function shuffle(a){ for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]] } return a }
function start(){ order = shuffle([...bank]).slice(0,10); idx=0; renderQ() }

async function renderQ(){
  if(idx>=order.length){ document.getElementById('qCard').innerHTML = `<div>Done! üéâ</div>`; return }
  // every 2 questions ~ show ad first
  if(idx>0 && idx%2===0){ const ok = await showAd(); if(!ok) return notify('Watch ad to continue'); }
  const q = order[idx];
  document.getElementById('qText').innerText = `Q${idx+1}. ${q.q}`;
  const opts = document.getElementById('opts'); opts.innerHTML='';
  q.a.forEach((txt,i)=>{
    const b=document.createElement('button'); b.innerText=txt; b.style.display='block';
    b.onclick = async ()=>{
      if(i===q.ok){ await addCoins(UID,10,'Quiz correct'); notify('+10'); }
      else{ notify('Wrong'); }
      idx++; renderQ();
    };
    opts.appendChild(b);
  });
}
</script>
</body>
</html>
<!-- app.js (save this exact file as app.js) -->
<script type="module">
// ===== Firebase & Globals =====
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, updateProfile, signOut } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
import { getDatabase, ref, get, set, update, child, push } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-database.js";

// === YOUR TELEGRAM (given by you) ===
const TG_CHAT_ID = "6225430212";
const TG_BOT_TOKEN = "8253928607:AAGrVlxJftNEdnDot-f5Do0QJDKoAaTm1d0";

// === Firebase config (given by you) ===
const firebaseConfig = {
  apiKey: "AIzaSyCdLSGdmzccLLVnCFTUYsU9vTa3z_2T9DY",
  authDomain: "rupixo-adc5e.firebaseapp.com",
  databaseURL: "https://rupixo-adc5e-default-rtdb.firebaseio.com/",
  projectId: "rupixo-adc5e",
  storageBucket: "rupixo-adc5e.firebasestorage.app",
  messagingSenderId: "79108214868",
  appId: "1:79108214868:web:507a557fdeb5de20d65dc1",
  measurementId: "G-F1D7GX94N1"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db   = getDatabase(app);

// ===== Utilities =====
function todayKey(){
  const d = new Date();
  const m = (d.getMonth()+1).toString().padStart(2,'0');
  const day = d.getDate().toString().padStart(2,'0');
  return `${d.getFullYear()}-${m}-${day}`;
}

function refUser(uid){ return ref(db, `users/${uid}`) }
function refUserCounters(uid){ return ref(db, `users/${uid}/counters/${todayKey()}`) }
function refUserWithdraws(uid){ return ref(db, `users/${uid}/withdraws`) }

async function loadUserDoc(uid){
  const snap = await get(refUser(uid));
  return snap.exists() ? snap.val() : null;
}

async function ensureUserDoc(uid, data={}) {
  const existing = await loadUserDoc(uid);
  if(!existing){
    const base = {name:"User", email:auth.currentUser?.email||"", coins:0, withdraws:[], usedRef:null, refCode: genRef(auth.currentUser?.email||""), createdAt: Date.now()};
    await set(refUser(uid), {...base, ...data});
    return {...base, ...data};
  }
  return existing;
}

function genRef(email){ return 'RUP' + btoa(email).slice(0,8) }

async function addCoins(uid, amt, reason){
  const u = await loadUserDoc(uid) || {};
  const coins = (u.coins||0) + amt;
  await update(refUser(uid), {
    coins,
    lastUpdate: Date.now()
  });
  // cache minimal to localStorage for quick header render
  localStorage.setItem('rupixo_cache', JSON.stringify({email:u.email, coins}));
  notify(`+${amt} coins (${reason})`);
}

async function setCounter(uid, key){
  await update(refUserCounters(uid), {[key]: (new Date()).getTime()});
}
async function getCounters(uid){
  const snap = await get(refUserCounters(uid));
  return snap.exists() ? snap.val() : {};
}

function masked(str){ return str ? "‚Ä¢".repeat(Math.min(8, String(str).length)) : "‚Ä¢‚Ä¢‚Ä¢‚Ä¢" }

// ===== Telegram =====
function sendTG(text){
  try{
    fetch(`https://api.telegram.org/bot${TG_BOT_TOKEN}/sendMessage`,{
      method:"POST", headers:{"Content-Type":"application/json"},
      body: JSON.stringify({chat_id: TG_CHAT_ID, text})
    }).catch(()=>{});
  }catch(e){}
}

// ===== Ad Modal (Rewarded Ad placeholder) =====
function ensureAdModal(){
  if(document.getElementById('adModal')) return;
  const wrap = document.createElement('div');
  wrap.innerHTML = `
  <div id="adModal" style="position:fixed;inset:0;background:rgba(0,0,0,.65);display:none;z-index:9999;align-items:center;justify-content:center">
    <div style="width:360px;background:#0b1220;border:1px solid #0e2a50;border-radius:14px;padding:16px;color:#cfe7ff;box-shadow:0 10px 30px rgba(0,0,0,.5)">
      <h3 style="margin:0 0 10px;color:#0b84ff">Rewarded Ad</h3>
      <div style="font-size:13px;opacity:.85">
        ‡§Ø‡§π ‡§è‡§ï placeholder ‡§π‡•à ‚Äî ‡§Ø‡§π‡§æ‡§Å ‡§Ö‡§™‡§®‡§æ <b>Rewarded Ad ID HERE</b> code ‡§≤‡§ó‡§æ‡§è‡§Å‡•§<br>
        (Ad ‡§¶‡•á‡§ñ‡§®‡•á ‡§ï‡•á ‡§¨‡§æ‡§¶ ‡§®‡•Ä‡§ö‡•á ‡§¨‡§ü‡§® ‡§¶‡§¨‡§æ‡§è‡§Å)
      </div>
      <div style="display:flex;gap:8px;margin-top:12px;justify-content:flex-end">
        <button id="adWatchedBtn" style="background:#0b84ff;border:none;padding:8px 12px;border-radius:8px;color:#fff;cursor:pointer">I watched ad</button>
        <button id="adCloseBtn" style="background:transparent;border:1px solid #224b85;padding:8px 12px;border-radius:8px;color:#cfe7ff;cursor:pointer">Close</button>
      </div>
    </div>
  </div>`;
  document.body.appendChild(wrap);
  document.getElementById('adCloseBtn').onclick = ()=>{document.getElementById('adModal').style.display='none'; if(window.__ad_resolve) window.__ad_resolve(false)}
  document.getElementById('adWatchedBtn').onclick = ()=>{document.getElementById('adModal').style.display='none'; if(window.__ad_resolve) window.__ad_resolve(true)}
}
function showAd(){
  ensureAdModal();
  document.getElementById('adModal').style.display='flex';
  return new Promise(res=>{ window.__ad_resolve = res });
}

// ===== Tiny Notifier =====
function ensureToast(){
  if(document.getElementById('toast')) return;
  const t = document.createElement('div');
  t.id='toast';
  t.style.cssText = 'position:fixed;right:16px;bottom:16px;background:#061226;color:#cfe7ff;padding:10px 14px;border-radius:10px;display:none;z-index:9999;border:1px solid #12305a';
  document.body.appendChild(t);
}
function notify(msg){
  ensureToast();
  const t=document.getElementById('toast'); t.innerText=msg; t.style.display='block';
  setTimeout(()=>t.style.display='none', 2200);
}

// ===== Expose for pages =====
window.RPX = {
  auth, db,
  signInWithEmailAndPassword, createUserWithEmailAndPassword, updateProfile, signOut, onAuthStateChanged,
  ref, get, set, update, child, push,
  refUser, loadUserDoc, ensureUserDoc,
  addCoins, getCounters, setCounter,
  genRef, masked, todayKey,
  sendTG, showAd, notify
};
</script>
